#!/usr/bin/env nix
#!nix shell nixpkgs#ffmpeg-full nixpkgs#yt-dlp nixpkgs#id3v2 nixpkgs#eyed3 -c zsh

# extract downloadable urls from yt-dlp because it no longer downloads the files
tmpfile=$(mktemp)

echo getting json and saving into $tmpfile
yt-dlp -J --yes-playlist "$1" > $tmpfile

# commented because opus files' album covers are not broadcasted by mpv
# download thumbnail, scale and crop it to 720x720
# thumbnail=thumbnail.jpeg
# thumbnail_url=$(jq -r '."entries".[0]."thumbnail"' $tmpfile)
# wget "$thumbnail_url"
# ffmpeg -i $(basename $thumbnail_url) -filter:v "scale=w=512:h=512:force_original_aspect_ratio=2,crop=512:512" $thumbnail
# rm $(basename $thumbnail_url)

padding=$(( $(echo $urls | tr ' ' '\n' | wc -l | wc -m) - 1 ))

tracks=$(echo $urls | tr ' ' '\n' | wc -l)

for index in {0..$tracks}
do
	# pad the index according to the width
	index=$(printf %0${padding}d $index)

	# use yt-dlp to download the video provided by the playlist (way faster than curl-ing from the google server)
	url=$(jq -r '."entries".['$(( $index - 1 ))']."webpage_url"' $tmpfile)

	# get artist
	artist=$(jq -r '."entries".['$(( $index - 1 ))']."artists".[0]' $tmpfile | tr '[A-Z]' '[a-z]' | tr ' ' '-')

	# get album name
	album=$(jq -r '."entries".['$(( $index - 1 ))']."album"' $tmpfile | tr '[A-Z]' '[a-z]' | tr ' ' '-')

	# clean up track name
	track=$(jq -r '."entries".['$(( $index - 1 ))']."track"' $tmpfile | tr '[A-Z]' '[a-z]' | sed 's/\.\|,//g' | sed 's/(.*)//' | tr ' ' '-')

	# yt-dlp "$url" -
	yt-dlp "$url" -o "$index-$track.%(ext)s"

	old_name=$(echo $index-$track.*)
	name=$index-$track.opus

	# convert to opus format
	ffmpeg -i $old_name $name
	rm $old_name

	id3v2 --TIT2 $name -t $name --TPE1 $artist -a $artist --TALB $album -A $album --TRCK $(( $index + 1 ))/$tracks -T $(( $index + 1 ))/$tracks $name
	# eyeD3 --add-image "$thumbnail:FRONT_COVER"
done

echo deleting tmpfile $tmpfile
rm $tmpfile

# # vim: ft=zsh
